# GoTSSH 测试文档

本文档描述了 GoTSSH 项目的测试架构和测试用例。

## 测试结构

### 测试文件组织

```
gotssh/
├── cmd/
│   └── cmd_test.go              # 命令行包测试
├── internal/
│   ├── config/
│   │   └── config_test.go       # 配置管理测试
│   ├── ssh/
│   │   └── client_test.go       # SSH客户端测试
│   ├── forward/
│   │   └── manager_test.go      # 端口转发管理测试
│   └── ui/
│       ├── menu_test.go         # UI菜单测试
│       └── credential_test.go   # 凭证管理UI测试
├── tests/
│   ├── integration_test.go      # 集成测试
│   └── testdata/
│       └── example-config.yaml  # 测试配置文件
├── main_test.go                 # 主程序测试
└── test.sh                      # 测试运行脚本
```

## 测试类型

### 1. 单元测试

每个包都有对应的单元测试文件，测试各个组件的基本功能：

- **cmd包测试** (`cmd/cmd_test.go`)
  - 测试各个命令的参数解析
  - 测试命令别名和标志
  - 测试服务器查询解析功能
  - 测试命令执行流程

- **config包测试** (`internal/config/config_test.go`)
  - 测试配置管理器的CRUD操作
  - 测试配置文件的保存和加载
  - 测试数据验证和错误处理
  - 测试配置类型和常量

- **ssh包测试** (`internal/ssh/client_test.go`)
  - 测试SSH客户端创建和配置
  - 测试不同认证方式的处理
  - 测试密钥文件处理
  - 测试错误处理和配置验证

- **forward包测试** (`internal/forward/manager_test.go`)
  - 测试端口转发管理器功能
  - 测试活动转发的管理
  - 测试超时配置和错误处理
  - 测试网络错误检测

- **ui包测试**
  - `menu_test.go`: 测试主菜单和数据显示
  - `credential_test.go`: 测试凭证管理UI

### 2. 集成测试

集成测试 (`tests/integration_test.go`) 验证多个组件之间的协作：

- **完整工作流程测试**
  - 测试从配置创建到使用的完整流程
  - 验证组件间的数据传递和关联

- **服务器-凭证集成测试**
  - 测试服务器配置与凭证的关联
  - 验证SSH客户端使用凭证的流程

- **端口转发集成测试**
  - 测试端口转发配置与服务器的关联
  - 验证端口转发管理器的完整功能

- **配置持久化测试**
  - 测试配置在程序重启后的持久性
  - 验证配置文件的完整性

- **错误处理测试**
  - 测试各种错误场景的处理
  - 验证系统的健壮性

- **并发访问测试**
  - 测试多线程环境下的配置访问
  - 验证线程安全性

- **性能测试**
  - 测试大量配置项下的性能表现
  - 验证系统的可扩展性

### 3. 主程序测试

主程序测试 (`main_test.go`) 验证程序入口点：

- 测试主函数的存在和可调用性
- 测试命令行参数处理
- 测试程序结构的正确性

## 测试数据

### 测试配置文件

`tests/testdata/example-config.yaml` 包含完整的测试配置数据：

- 3个测试服务器（不同认证方式）
- 3个端口转发配置（本地和远程）
- 3个测试凭证（密码和密钥）
- 完整的设置配置

## 运行测试

### 使用测试脚本

项目提供了完整的测试脚本 `test.sh`：

```bash
# 运行所有测试
./test.sh

# 只运行单元测试
./test.sh unit

# 只运行集成测试
./test.sh integration

# 运行性能测试
./test.sh benchmark

# 生成覆盖率报告
./test.sh coverage

# 运行竞态条件检测
./test.sh race

# 显示帮助信息
./test.sh help
```

### 手动运行测试

```bash
# 运行所有测试
go test ./...

# 运行特定包的测试
go test ./cmd
go test ./internal/config
go test ./internal/ssh
go test ./internal/forward
go test ./internal/ui
go test ./tests

# 运行测试并显示详细输出
go test -v ./...

# 运行性能测试
go test -bench=. ./...

# 生成覆盖率报告
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out

# 运行竞态条件检测
go test -race ./...
```

## 测试覆盖范围

### 功能覆盖

- ✅ 命令行参数解析和处理
- ✅ 配置文件的CRUD操作
- ✅ SSH客户端配置和认证
- ✅ 端口转发管理
- ✅ UI组件和用户交互
- ✅ 错误处理和边界情况
- ✅ 数据持久化
- ✅ 并发访问安全性

### 测试类型覆盖

- ✅ 单元测试
- ✅ 集成测试
- ✅ 性能测试
- ✅ 并发测试
- ✅ 错误场景测试
- ✅ 边界条件测试

## 测试最佳实践

### 测试编写原则

1. **独立性**: 每个测试应该独立运行，不依赖其他测试
2. **可重复性**: 测试结果应该是可重复的
3. **清晰性**: 测试名称和结构应该清晰易懂
4. **完整性**: 测试应该覆盖正常情况和异常情况

### 测试数据管理

1. **使用临时目录**: 每个测试使用独立的临时目录
2. **清理资源**: 测试结束后自动清理临时文件
3. **模拟数据**: 使用真实但安全的测试数据

### 错误处理测试

1. **边界条件**: 测试输入的边界值
2. **异常情况**: 测试各种错误场景
3. **资源限制**: 测试在资源不足时的行为

## 持续集成

测试脚本设计为支持持续集成环境：

- 自动依赖检查和下载
- 代码格式检查
- 静态代码分析
- 全面的测试覆盖
- 详细的测试报告

## 性能基准

项目包含性能基准测试，用于监控：

- 配置操作性能
- 内存使用情况
- 并发性能
- 大数据量下的表现

## 注意事项

### 测试限制

1. **网络测试**: 由于安全考虑，不进行真实的网络连接测试
2. **SSH连接**: 不测试实际的SSH连接，只测试配置和客户端创建
3. **用户交互**: UI测试主要验证数据处理，不测试实际的用户输入

### 测试环境要求

- Go 1.23 或更高版本
- 支持testify测试框架
- 支持临时文件系统操作
- 支持并发测试

## 贡献测试

添加新测试时请遵循：

1. 为新功能添加对应的单元测试
2. 为复杂功能添加集成测试
3. 为性能敏感的代码添加基准测试
4. 更新相关文档
5. 确保所有测试通过

## 问题排查

常见测试问题及解决方案：

1. **权限问题**: 确保测试目录有读写权限
2. **依赖问题**: 运行 `go mod tidy` 确保依赖正确
3. **竞态条件**: 使用 `go test -race` 检测并发问题
4. **内存泄漏**: 检查测试中的资源清理

---

如有测试相关问题，请查看测试输出的详细错误信息，或运行 `./test.sh help` 获取更多帮助。 